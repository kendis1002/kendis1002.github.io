---
title: 'Notification trong Android v·ªõi Firebase Cloud Messaging (FCM)'
date: '2025-09-15'
lastmod: '2025-09-15'
tags: ['android', 'firebase']
draft: false
summary: 'Notification trong Android v·ªõi Firebase Cloud Messaging (FCM)'
images: ['/static/images/twitter-card.png']
---

G·∫ßn nh∆∞ h·∫ßu h·∫øt c√°c ·ª©ng d·ª•ng hi·ªán nay ƒë·ªÅu c√≥ ch·ª©c nƒÉng th√¥ng b√°o (notification). 
B√†i vi·∫øt d∆∞·ªõi ƒë√¢y s·∫Ω h∆∞·ªõng d·∫´n c·∫•u tr√∫c, c√°ch implement ch·ª©c nƒÉng notification ƒë√≥ tr√™n Android b·∫±ng Firebase Notification Messaging.

---

## Ki·∫øn tr√∫c t·ªïng quan v·ªÅ Notification

- **Server**: Backend s·∫Ω g·ª≠i th√¥ng b√°o (qua Firebase Cloud Messaging ‚Äì FCM).
- **Firebase**: ƒê√≥ng vai tr√≤ trung gian nh·∫≠n request t·ª´ server, ƒë·∫©y xu·ªëng device.
- **Android app**: L·∫Øng nghe v√† hi·ªÉn th·ªã notification. N·∫øu notification c√≥ ch·ª©a deeplink ‚Üí m·ªü ƒë√∫ng m√†n h√¨nh khi user nh·∫•n.

## C√°c lo·∫°i th√¥ng b√°o

Tr√™n Android, d·ª±a v√†o tr·∫°ng th√°i c·ªßa application s·∫Ω chia ra l√†m 2 lo·∫°i th√¥ng b√°o ch√≠nh m√† c√°ch th·ª©c ho·∫°t ƒë·ªông c·ªßa ch√∫ng kh√°c nhau:

| **Tr·∫°ng th√°i App** | **Payload notification** | **Payload data** |
|---------------------|--------------------------|------------------|
| Foreground          | Kh√¥ng auto hi·ªÉn th·ªã, ```onMessageReceived()``` s·∫Ω ƒë∆∞·ª£c g·ªçi nh∆∞ng kh√¥ng show ‚Üí b·∫°n ph·∫£i t·ª± hi·ªán notification. | H√†m onMessageReceived() lu√¥n ƒë∆∞·ª£c g·ªçi, |
| Background/Terminated          | Hi·ªÉn th·ªã UI t·ª± ƒë·ªông (n·∫øu c√≥ `notification` payload). | App kh√¥ng nh·∫≠n s·ª± ki·ªán ngay l·∫≠p t·ª©c. |

T·ªïng k·∫øt l·∫°i, v·ªõi foreground th√¨ l√∫c ƒë√≥ application c·ªßa b·∫°n s·∫Ω ƒëang ·ªü tr√™n m√†n h√¨nh v√† b·∫°n c√≥ th·ªÉ custom ƒë∆∞·ª£c c√°ch hi·ªÉn th·ªã c·ªßa th√¥ng b√°o ƒë√≥ ngay ch√≠nh tr√™n application th√†nh 1 popup, 1 dialog hay toast‚Ä¶. C√≤n ƒë·ªëi v·ªõi background/terminated th√¨ kh√¥ng th·ªÉ custom ƒë∆∞·ª£c v√† th√¥ng b√°o s·∫Ω hi·ªÉn th·ªã th√¥ng tin theo format c·ªßa h·ªá ƒëi·ªÅu h√†nh v·ªõi c√°c th√¥ng tin m√† server g·ª≠i sang.

Tuy nhi√™n trong th·ª±c t·∫ø ng∆∞·ªùi ta s·∫Ω l√†m cho ```onMessageReceived``` lu√¥n nh·∫≠n ƒë·ªÉ c√≥ th·ªÉ custom ƒë∆∞·ª£c channel, custom ƒë∆∞·ª£c n·ªôi dung th√¥ng b√°o, deeplink‚Ä¶ v√† c√°ch ƒë√≥ s·∫Ω ƒë∆∞·ª£c gi·∫£i th√≠ch sau.

Note: **onMessageReceived()** l√† h√†m trong class k·∫ø th·ª´a t·ª´ FirebaseMessagingService, h√†m n√†y s·∫Ω ƒë∆∞·ª£c g·ªçi m·ªói khi c√≥ tin nh·∫Øn g·ª≠i ƒë·∫øn.

## L√†m sao ƒë·ªÉ Server bi·∫øt ƒë∆∞·ª£c c·∫ßn g·ª≠i cho thi·∫øt b·ªã n√†o?

Th∆∞·ªùng th√¨ s·∫Ω c√≥ 2 c√°ch: server g·ª≠i theo fcmToken ho·∫∑c device s·∫Ω subscribe v√†o 1 topic v√† server s·∫Ω g·ª≠i notification v√†o topic ƒë√≥

### C√°ch 1: G·ª≠i theo FCM Token (Device Token)

* Khi app c√†i l·∫ßn ƒë·∫ßu, Firebase t·∫°o cho app 1 FCM Registration Token duy nh·∫•t.
* Token n√†y ƒë∆∞·ª£c l·∫•y trong Android b·∫±ng:
```kotlin
FirebaseMessaging.getInstance().token.addOnCompleteListener { task ->
    if (task.isSuccessful) {
        val token = task.result
        // G·ª≠i token n√†y l√™n server, g·∫Øn v·ªõi user ƒëang login
    }
}
```
* M·ªói token ƒë·∫°i di·ªán cho 1 instance app tr√™n 1 thi·∫øt b·ªã.
* Khi user ƒëƒÉng nh·∫≠p ‚Üí app g·ª≠i token l√™n server (k√®m userId).
* Server l∆∞u v√†o database t∆∞∆°ng ·ª©ng v·ªõi t·ª´ng user.
* Sau n√†y, khi c·∫ßn g·ª≠i notification cho user c·ª• th·ªÉ ‚Üí server l·∫•y token t∆∞∆°ng ·ª©ng ƒë·ªÉ g·ªçi API FCM.
* L∆∞u √Ω: Token c√≥ th·ªÉ thay ƒë·ªïi (v√≠ d·ª• khi app ƒë∆∞·ª£c c√†i l·∫°i, ho·∫∑c user x√≥a d·ªØ li·ªáu app). V√¨ v·∫≠y c·∫ßn c·∫≠p nh·∫≠t token ƒë·ªãnh k·ª≥ (v√≠ d·ª• m·ªói l·∫ßn app kh·ªüi ƒë·ªông).

üëâ Tr∆∞·ªùng h·ª£p n√†y server bi·∫øt "ƒë·ªãa ch·ªâ" user th√¥ng qua token m√† app g·ª≠i l√™n khi login.

### C√°ch 2: G·ª≠i theo Topic
* App c√≥ th·ªÉ subscribe v√†o 1 ho·∫∑c nhi·ªÅu topic.
* Tr√™n Android:

```kotlin
FirebaseMessaging.getInstance().subscribeToTopic("news")
```
* Server g·ª≠i notification ƒë·∫øn t·∫•t c·∫£ thi·∫øt b·ªã ƒë√£ subscribe v√†o topic ƒë√≥.

```kotlin
{
  "to": "/topics/news",
  // D√πng "body" ƒë·ªÉ custom notification
  "notification": {
    "title": "Breaking News",
    "body": "New article available!"
  }
}
```

üëâ D√πng cho broadcast: g·ª≠i th√¥ng b√°o s·ª± ki·ªán, tin t·ª©c, khuy·∫øn m√£i.


## Implement ·ªü Server

·ªû ƒë√¢y t√¥i s·∫Ω s·ª≠ d·ª•ng Nodejs

### B∆∞·ªõc 1: T·∫°o Firebase Project v√† t·∫£i file json c·∫•u h√¨nh
* V√†o Firebase Console ‚Üí t·∫°o project.
* B·∫≠t Cloud Messaging.

Service Account Key
* V√†o Project Settings ‚Üí Service accounts ‚Üí Generate new private key.
* T·∫£i file .json v·ªÅ (g·ªìm client_email, private_key).

### B∆∞·ªõc 2: C√†i ƒë·∫∑t th∆∞ vi·ªán firebase-admin

```bash
npm install firebase-admin
```

### B∆∞·ªõc 3: G·ª≠i notification
```javascript

const admin = require("firebase-admin");

// Load key JSON t·∫£i t·ª´ Firebase
const serviceAccount = require("./firebase-service-account.json");

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});

async function sendToDevice(token) {
  const message = {
    token: token,
    data: {
      title: "Th√¥ng b√°o m·ªõi",
      body: "B·∫°n c√≥ tin nh·∫Øn m·ªõi!",
      deeplink: "myapp://profile/123"
    },
    // N·∫øu mu·ªën h·ªá th·ªëng Android t·ª± hi·ªÉn th·ªã khi background:
    notification: {
      title: "Th√¥ng b√°o m·ªõi",
      body: "B·∫°n c√≥ tin nh·∫Øn m·ªõi!"
    }
  };

  try {
    const response = await admin.messaging().send(message);
    console.log("Sent successfully:", response);
  } catch (error) {
    console.error("Error sending message:", error);
  }
};

async function sendToTopic() {
  const message = {
    topic: "news",
    data: {
      title: "Th√¥ng b√°o m·ªõi",
      body: "B·∫°n c√≥ tin nh·∫Øn m·ªõi!",
      deeplink: "myapp://profile/123"
    },
    // N·∫øu mu·ªën h·ªá th·ªëng Android t·ª± hi·ªÉn th·ªã khi background:
    notification: {
      title: "Tin t·ª©c m·ªõi",
      body: "H√£y ƒë·ªçc b√†i vi·∫øt n√≥ng h·ªïi s√°ng nay!"
    }
  };

  try {
    const response = await admin.messaging().send(message);
    console.log("Sent to topic:", response);
  } catch (error) {
    console.error("Error:", error);
  }
};
```

N·∫øu mu·ªën lu√¥n lu√¥n g·ªçi h√†m ```onMessageReceived()``` th√¨ ch·ªâ c·∫ßn d√πng field ```data``` v√† b·ªè ƒëi field ```notification```. C∆° b·∫£n l√† th·∫ø.

## Implement ·ªü Android

### B∆∞·ªõc 1: Th√™m Firebase v√†o project Android
### B∆∞·ªõc 2: Th√™m dependency

```gradle
implementation 'com.google.firebase:firebase-messaging:24.0.0'
```

### B∆∞·ªõc 3: T·∫°o class k·∫ø th·ª´a FirebaseMessagingService

```kotlin

@HiltAndroidApp
class MyApplication : Application()

@AndroidEntryPoint
class MyFirebaseMessagingService : FirebaseMessagingService() {

    override fun onMessageReceived(remoteMessage: RemoteMessage) {
        // N·∫øu server g·ª≠i "notification" payload th√¨ h·ªá th·ªëng t·ª± hi·ªÉn th·ªã
        // N·∫øu g·ª≠i "data" payload th√¨ ta t·ª± custom
        val data = remoteMessage.data
        val deeplink = data["deeplink"]

        showNotification(
            title = data["title"] ?: "Th√¥ng b√°o",
            message = data["body"] ?: "",
            deeplink = deeplink
        )
    }

    override fun onNewToken(token: String) {
        // G·ª≠i token n√†y l√™n server ƒë·ªÉ g·∫Øn v·ªõi user
    }

    private fun showNotification(title: String, message: String, deeplink: String?) {
        val intent = Intent(this, MainActivity::class.java).apply {
            flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TASK
            deeplink?.let {
                data = Uri.parse(it) // v√≠ d·ª•: myapp://profile/123
            }
        }
        val pendingIntent = PendingIntent.getActivity(
            this, 0, intent, PendingIntent.FLAG_IMMUTABLE
        )

        val channelId = "my_channel_id"
        val builder = NotificationCompat.Builder(this, channelId)
            .setSmallIcon(R.drawable.ic_notification)
            .setContentTitle(title)
            .setContentText(message)
            .setContentIntent(pendingIntent)
            .setAutoCancel(true)

        val manager = getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            val channel = NotificationChannel(channelId, "General", NotificationManager.IMPORTANCE_DEFAULT)
            manager.createNotificationChannel(channel)
        }
        manager.notify(1, builder.build())
    }
}
```

### B∆∞·ªõc 4: ƒêƒÉng k√Ω service trong AndroidManifest.xml

```xml
<service
    android:name=".MyFirebaseMessagingService"
    android:exported="false">
    <intent-filter>
        <action android:name="com.google.firebase.MESSAGING_EVENT" />
    </intent-filter>
</service>
```

### B∆∞·ªõc 5: Th√™m quy·ªÅn n·∫øu ch∆∞a c√≥ s·∫µn

```xml
<uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
```

### B∆∞·ªõc 6: Y√™u c·∫ßu quy·ªÅn (Android 13+)

```kotlin

@Composable
fun NotificationPermissionRequest() {
    val context = LocalContext.current
    val permissionLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.RequestPermission(),
        onResult = { isGranted ->
            if (isGranted) {
                Toast.makeText(context, "Notification permission granted", Toast.LENGTH_SHORT).show()
            } else {
                Toast.makeText(context, "Notification permission denied", Toast.LENGTH_SHORT).show()
            }
        }
    )

    // Ch·ªâ request n·∫øu Android 13+ (API 33 tr·ªü l√™n)
    LaunchedEffect(Unit) {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            permissionLauncher.launch(Manifest.permission.POST_NOTIFICATIONS)
        }
    }
}

@Composable
fun MainScreen() {
    NotificationPermissionRequest()

    // ... n·ªôi dung UI ch√≠nh
}
```

### B∆∞·ªõc 7: T·∫°o deeplink trong AndroidManifest.xml

C√°i n√†y c≈©ng tu·ª≥ c√°ch implement navigation c·ªßa b·∫°n, Jetpack navigation hay Jetpack Compose Navigation 2 hay 3 m√† implement. C∆° b·∫£n n√≥ s·∫Ω theo deeplink ƒë∆∞·ª£c server g·ª≠i v·ªÅ (‚Äúmyapp://profile/123‚Äù nh∆∞ ·ªü v√≠ d·ª• tr√™n).

### B∆∞·ªõc 8: G·ª≠i token l√™n server khi c√≥ token m·ªõi

```kotlin
@AndroidEntryPoint
class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        FirebaseMessaging.getInstance().token.addOnCompleteListener { task ->
            if (!task.isSuccessful) {
                Log.w("FCM", "Fetching FCM registration token failed", task.exception)
                return@addOnCompleteListener
            }

            // L·∫•y token
            val token = task.result
            Log.d("FCM", "FCM token: $token")

            // TODO: G·ª≠i token l√™n server c·ªßa b·∫°n
        }
    }
}

@AndroidEntryPoint
class MyFirebaseMessagingService : FirebaseMessagingService() {
    // ...
    override fun onNewToken(token: String) {
        super.onNewToken(token)
        Log.d("FCM", "Refreshed token: $token")

        // TODO: G·ª≠i token m·ªõi l√™n server
    }
}
```

## K·∫øt lu·∫≠n

V·ª´a r·ªìi l√† to√†n b·ªô c√°c b∆∞·ªõc ƒë·ªÉ implement ch·ª©c nƒÉng notification trong Android v·ªõi Firebase Cloud Messaging (FCM). Hy v·ªçng b√†i vi·∫øt s·∫Ω gi√∫p b·∫°n c√≥ c√°i nh√¨n t·ªïng quan v√† chi ti·∫øt v·ªÅ c√°ch th·ª©c ho·∫°t ƒë·ªông c≈©ng nh∆∞ c√°ch implement ch·ª©c nƒÉng n√†y trong ·ª©ng d·ª•ng c·ªßa m√¨nh.